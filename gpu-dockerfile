# 使用 nvidia/cuda 作为基础镜像
FROM nvidia/cuda:12.3.1-base-ubuntu22.04
USER root

# 设置环境变量
ARG version=1.8.7
ENV name="1" 
ENV num=1
ENV token="MUHHZYNAUSWPQAPQVEEDPWVOIQTBJBBZFAJKZURUGBAIKFAPHRUYPUMFGFEG"
ENV url="https://mine.qubic.li/"


# 换源为清华源并更新源，创建目录并下载解压qli-Client，更改appsettings.json
RUN apt-get update && apt-get install -y libicu-dev wget && \
  rm -rf /var/lib/apt/lists/* && \
  mkdir /q && \
  wget -O /q/qli-Client-${version}-Linux-x64.tar.gz https://dl.qubic.li/downloads/qli-Client-${version}-Linux-x64.tar.gz && \
  tar -xzvf /q/qli-Client-${version}-Linux-x64.tar.gz -C /q/ && \ 
  rm /q/qli-Client-${version}-Linux-x64.tar.gz && \   
  mv /q/qli-Client /q/trainer 
RUN  wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb 
RUN sudo dpkg -i cuda-keyring_1.1-1_all.deb  && sudo apt update -y && sudo apt -y install cuda-toolkit && export LD_LIBRARY_PATH=/usr/local/cuda-12.2/lib64:${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}} && rm cuda-keyring_1.1-1_all.deb

# 设置工作目录
WORKDIR /q

# 在容器启动时运行命令
CMD sh -c "echo '{\"Settings\": {\"baseUrl\": \"$url\",\"amountOfThreads\": $num,\"payoutId\": \"$token\",\"accessToken\": null,\"overwrites\": {\"CUDA\": \"12\"},\"allowHwInfoCollect\": true,\"alias\": \"$name\"}}' > appsettings.json && ./trainer"
